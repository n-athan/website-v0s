let c,r,a,q,score,morelines,fourlines,threelines,twolines,oneline,gameOver,pauze;function preload(){hit=loadSound("tetrisSounds\\hit.mp3")}function setup(){scl=25,cols=floor(select("#cols").value()),(3>cols||40<cols)&&(alert("Number of colums must be between 3 and 40. Number set to 15."),cols=15,select("#cols").value(15)),rows=floor(select("#rows").value()),(3>rows||40<rows)&&(alert("Number of rows must be between 3 and 40. Number set to 15."),rows=15,select("#rows").value(15)),w=cols*scl,h=rows*scl,createCanvas(w,h),colorMode(HSL,360,100,100,1),rectMode(CORNER),grid=[],s=20,c=floor(width/scl),r=floor(height/scl),q=new Quatra,score=0,gameOver=!1,pauze=!1;let a=0;for(let b=0;b<r;b++)for(let b=0;b<c;b++)grid[a]=[0,0,0,0],a++;for(let a in highscore=window.localStorage.getItem("vier"),highscore=JSON.parse(highscore),null==highscore&&(highscore={}),select("#scoreP").html("Score: "+score),highscoreT="<table><tr class='en'><td>ColumnsxRows</td><td>Highscore</td></tr><tr class='nl'><td>KolommenxRijen</td><td>Highscore</td></tr>",highscore)highscoreT+="<tr><td>"+a+"</td><td>"+highscore[a]+"</td></tr>";highscoreT+="</table>",select("#highScoreP").html(highscoreT),document.getElementById("defaultCanvas0").focus(),hit.setVolume(.1),morelines=loadSound("tetrisSounds\\moreLines.mp3"),fourlines=loadSound("tetrisSounds\\4lines.mp3"),threelines=loadSound("tetrisSounds\\3lines.mp3"),twolines=loadSound("tetrisSounds\\2lines.mp3"),oneline=loadSound("tetrisSounds\\1line.mp3")}function draw(){background(30,10,60,1),select("#scoreP").html("Score: "+score),noStroke();let b=0;for(let a=0;a<r;a++)for(let d=0;d<c;d++)fill(grid[b][0],grid[b][1],grid[b][2],grid[b][3]),b++,rect(d*scl,a*scl,scl,scl);removeLine(),gameOver?end&&(a+=.01,end.background(color(267,100,38,a)),end.text(text,width/2,height/2),image(end,0,0)):(isGameOver(),q.show(),q.update())}function keyPressed(){keyCode===UP_ARROW?q.rotLeft():keyCode===DOWN_ARROW?q.rotRight():keyCode===LEFT_ARROW?q.move(-1):keyCode===RIGHT_ARROW?q.move(1):32===keyCode?q.moveDown():27===keyCode&&(pauze?loop():noLoop(),pauze=!pauze)}function removeLine(){let a=0;for(let b,d=r-1;0<=d;d--){b=0;for(let e=0;e<c;e++)if(0==alpha(grid[d*c+e]))e+=c+1;else if(0<alpha(grid[d*c+e])&&(b+=1,b==c)){score+=c,a+=1;for(let a=d;0<a;a--)for(let b=0;b<c;b++)grid[a*c+b]=grid[(a-1)*c+b];checkSpeed()}}playSound(a)}function checkSpeed(){0<score&&0==score%(5*c)&&(s-=1,constrain(s,0,100))}function playSound(a){5<=a?morelines.play():4==a?fourlines.play():3==a?threelines.play():2==a?twolines.play():1==a&&oneline.play()}function isGameOver(){for(let a=0;a<=c;a++)0<alpha(grid[a])&&(console.log("game over"),gameOver=!0,endGame())}function refresh(){console.log("refresh"),select("#scoreP").html("Score: 0"),setup()}function endGame(){let a=cols.toString()+"x"+rows.toString(),b=highscore[a];b?score>b&&(highscore[a]=score):highscore[a]=score,endScreen(b),console.log(highscore),window.localStorage.setItem("vier",JSON.stringify(highscore)),setTimeout(function(){end=void 0,refresh()},3e3)}function endScreen(a){a=0,end=createGraphics(width,height),end.colorMode(HSL,360,100,100,1),end.background(color(267,100,38,0)),end.textAlign(CENTER),end.fill(249,30,10,1),text="Score: "+score,(score>a||!a)&&(text+="\n New Highscore!"),end.textFont("Space Mono"),end.textSize(scl),end.textStyle(BOLD),end.text(text,width/2,height/2),movesLeft="-"}shapes=[[[0,0,0,0],[0,1,0,0],[1,1,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[0,0,1,1],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,0,0,0],[1,1,1,0],[0,0,0,0]],[[0,0,0,0],[0,0,1,0],[1,1,1,0],[0,0,0,0]]],colors=[50,220,10,"g","w","g","w"];class Quatra{constructor(){this.i=-2,this.j=floor(c/2-2),this.r=floor(random(0,7)),this.shape=shapes[this.r],this.clr="g"==colors[this.r]?color(10,10,10,1):"w"==colors[this.r]?color(0,0,100,1):color(colors[this.r],90,50,1),this.speed=s,this.speedcounter=0}show(){fill(this.clr),noStroke();for(let a=0;4>a;a++)for(let b=0;4>b;b++)1==this.shape[a][b]&&rect((this.j+b)*scl,(this.i+a)*scl,scl,scl)}update(){this.speedcounter==this.speed&&(this.i+=1,this.stopMoving("vert",1),this.speedcounter=0),this.speedcounter++}stopMoving(a,b){if(this.hasHit()){hit.play(),"vert"==a&&(this.i-=b);for(let a=0;4>a;a++)for(let b=0;4>b;b++){let d=this.i+a,e=this.j+b,f=d*c+e;1==this.shape[a][b]&&(grid[f]=[hue(this.clr),saturation(this.clr),lightness(this.clr),alpha(this.clr)])}return q=new Quatra,!0}}rotLeft(){let a=[[],[],[],[]];for(let b=0;4>b;b++)for(let c=0;4>c;c++)a[c][b]=this.shape[b][3-c];this.shape=a;let b=this.getMax();this.j+b[0]>=c-1?this.j-=1:0>=this.j+b[2]&&(this.j+=1)}rotRight(){let a=[[],[],[],[]];for(let b=0;4>b;b++)for(let c=0;4>c;c++)a[c][b]=this.shape[3-b][c];this.shape=a;let b=this.getMax();this.j+b[0]>=c-1?this.j-=1:0>=this.j+b[2]&&(this.j+=1)}move(a){let b=this.getMax();if(1==a){if(this.j+b[0]>=c-1)return;this.j+=a,this.hasHit()&&(this.j-=a)}else if(-1==a){if(0>=this.j+b[2])return;this.j+=a,this.hasHit()&&(this.j-=a)}}moveDown(){let a=this.getDistBottom();this.i+=a}getMax(){let a=4,b=-1,c=4;for(let d=0;4>d;d++)for(let e=0;4>e;e++)1==this.shape[d][e]&&(a=min(a,e),b=max(b,e),c=max(c,d));return[b,c,a]}getDistBottom(){let a=this.getMax(),b=r-(this.i+a[1]);for(let d=a[2]+this.j;d<=a[0]+this.j;d++)for(let e=a[1]+this.i;e<r;e++)0<alpha(grid[e*c+d])&&(b=min(b,e-(a[1]+this.i)));return b}hasHit(){for(let a=0;4>a;a++)for(let b=0;4>b;b++)if(1==this.shape[a][b]){let d=(this.i+a)*c+this.j+b;if(0>d);else{if(d>c*r-1)return!0;if(0<alpha(grid[d]))return!0}}return!1}}